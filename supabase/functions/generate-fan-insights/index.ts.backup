import { serve } from "https://deno.land/std@0.177.0/http/server.ts"
import { corsHeaders } from '../_shared/cors.ts'

const OPENAI_API_KEY = Deno.env.get('OPENAI_API_KEY')

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    if (!OPENAI_API_KEY) {
      throw new Error('OpenAI API key not configured')
    }

    const { user_id, event_history, preferences } = await req.json()

    if (!user_id) {
      throw new Error('User ID is required')
    }

    // Create prompt for generating fan insights
    const prompt = `
You are a K-pop fan analyst. Analyze the following user data and provide personalized insights and recommendations.

User Event History: ${event_history?.join(', ') || 'No events attended yet'}
User Preferences: ${preferences?.join(', ') || 'No preferences specified'}

Please provide:
1. 3-5 personalized insights about their fan journey
2. 3-5 recommendations for future events or activities

Format your response as JSON with this structure:
{
  "insights": [
    {
      "type": "spending_pattern" | "event_preference" | "artist_affinity" | "growth_opportunity",
      "title": "Brief title",
      "description": "Detailed insight",
      "value": numerical_value_if_applicable
    }
  ],
  "recommendations": [
    "Recommendation 1",
    "Recommendation 2",
    ...
  ]
}
`

    // Call OpenAI API
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${OPENAI_API_KEY}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [
          {
            role: 'system',
            content: 'You are a helpful K-pop fan analyst who provides personalized insights.'
          },
          {
            role: 'user',
            content: prompt
          }
        ],
        temperature: 0.7,
        max_tokens: 1500
      })
    })

    if (!response.ok) {
      throw new Error(`OpenAI API error: ${response.status}`)
    }

    const data = await response.json()
    const content = data.choices[0]?.message?.content

    if (!content) {
      throw new Error('No insights generated')
    }

    // Try to parse JSON response, fallback to structured data if parsing fails
    let insights
    try {
      insights = JSON.parse(content)
    } catch {
      // Fallback if AI doesn't return valid JSON
      insights = {
        insights: [
          {
            type: "growth_opportunity",
            title: "Your Fan Journey",
            description: content.substring(0, 200) + "...",
            value: null
          }
        ],
        recommendations: [
          "Explore new artists in your favorite genres",
          "Join fan communities for better concert experiences",
          "Set up budget alerts for upcoming events"
        ]
      }
    }

    return new Response(
      JSON.stringify(insights),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      }
    )

  } catch (error) {
    console.error('Generate insights error:', error)
    
    // Return fallback insights on error
    const fallbackInsights = {
      insights: [
        {
          type: "growth_opportunity",
          title: "Welcome to Your Fan Journey!",
          description: "Start exploring K-pop events and building your preferences to get personalized insights.",
          value: null
        }
      ],
      recommendations: [
        "Set up your favorite artists and genres",
        "Browse upcoming K-pop events in your area", 
        "Create a concert budget to track your spending",
        "Join fan communities for tips and recommendations"
      ]
    }
    
    return new Response(
      JSON.stringify(fallbackInsights),
      { 
        status: 200, // Return 200 with fallback data instead of error
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      }
    )
  }
})